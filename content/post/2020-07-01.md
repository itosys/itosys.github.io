+++
title = "C言語でソケットプログラミング(1)"
date = 2020-05-05
lastmod = 2020-05-05
tags = ["study"]
categories = []
imgs = []
cover = ""  # image show on top
readingTime = 5  # show reading time after article date
toc = true
comments = false
justify = false  # text-align: justify;
single = false  # display as a single page, hide navigation on bottom, like as about page.
license = ""  # CC License
draft = true
+++

## やりたいこと
現在とあるプロジェクトではCI/CDにCircleCIを使用してます。
インフラではAWSのECSを使用しており、CircleCIでは

- test
- CIRCLE_SHA1をtagにdocker build
- ECRへのimageのpush
- 特定のブランチならリリースjobへhold
- リリースjob実行でECSのserviceを更新

といったことをやっています。

そして今回問題になったことが、しばらく開発していないサービスのECSで問題が起きました。
ECRのLifecycle Policyによりデプロイされいてるimageが消され、ECSでimage pullが失敗するループが発生していました。
コミットしてCI/CDを動かしてすぐに解決しましたが、これの解決策として

- リリース物にはgit tagをつける
- ECRへpushするimageにgit tagをtagとしてつける
- 正規表現で特定のtagがついているimageはECRのLifecycle Policyで消されないようにする

ということを決め、これを実装したので書いていきます。

